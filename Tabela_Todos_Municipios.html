<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tabela de Dados - Portal Meteorológico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --secondary-color: #198754;
            --primary-color: var(--secondary-color); 
            --dark-color: #198754;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f5f7fa;
        }
        .navbar {
            background-color: var(--dark-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .footer {
            background-color: var(--dark-color);
            color: white;
        }
        .focus-visible:focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: var(--primary-color);
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #city-filter-options::-webkit-scrollbar {
            width: 8px;
        }
        #city-filter-options::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        #city-filter-options::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        #city-filter-options::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <nav class="navbar py-4" aria-label="Navegação principal">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="/Logo/radar_meteorológico.png" alt="Portal Meteorológico" class="h-12 w-auto">
                    <h1 class="text-xl font-bold text-white">Radar Meteorológico</h1>
                </div>
                <div class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-gray-200 hover:text-white transition focus-visible">Dashboard</a>
                    <a href="Tabela_Todos_Municipios.html" class="text-gray-200 font-medium hover:text-white transition focus-visible">Tabela de Municípios</a>
                    <a href="Contato.html" class="text-gray-200 hover:text-white transition focus-visible">Contato</a>
                    <a href="Sobre.html" class="text-gray-200 hover:text-white transition focus-visible">Sobre</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-200 hover:text-white focus-visible" aria-expanded="false" aria-controls="mobile-menu">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden mt-4 space-y-2">
                <a href="index.html" class="block py-2 px-4 text-gray-300 hover:bg-green-700 rounded-md focus-visible">Dashboard</a>
                <a href="Tabela_Todos_Municipios.html" class="block py-2 px-4 bg-green-100 text-green-800 font-medium rounded-md focus-visible">Tabela de Municípios</a>
                <a href="Contato.html" class="block py-2 px-4 text-gray-300 hover:bg-green-700 rounded-md focus-visible">Contato</a>
                <a href="Sobre.html" class="block py-2 px-4 text-gray-300 hover:bg-green-700 rounded-md focus-visible">Sobre</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Painel de Controle de Dados</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-4 mb-6">
                
                <div>
                    <label for="state-filter" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Estado</label>
                    <select id="state-filter" class="h-10 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                        <option value="todos">Todos os Estados</option>
                        <option value="RO">Rondônia</option>
                        <option value="AC">Acre</option>
                        <option value="MT">Mato Grosso</option>
                    </select>
                </div>

                <div>
                    <label for="city-filter-button" class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Município</label>
                    <div id="city-filter-container" class="relative">
                        <button id="city-filter-button" type="button" class="h-10 text-left w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 focus:outline-none focus:ring-1 focus:ring-green-500 focus:border-green-500" disabled>
                            <span id="city-filter-text" class="block truncate text-gray-500">Selecione um estado</span>
                            <span class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </span>
                        </button>
                        <div id="city-filter-options" class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto focus:outline-none sm:text-sm">
                        </div>
                    </div>
                </div>
                
                <div class="flex flex-col justify-end">
                    <button id="fetch-button" class="h-10 w-full bg-green-600 text-white font-bold py-2 px-4 rounded hover:bg-green-700 transition duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-sync-alt"></i> Atualizar e Salvar
                    </button>
                </div>
                <div class="flex flex-col justify-end">
                     <button id="clear-filters-button" class="h-10 w-full bg-gray-500 text-white font-bold py-2 px-4 rounded hover:bg-gray-600 transition duration-300 flex items-center justify-center gap-2">
                        <i class="fas fa-times"></i> Limpar Filtros
                    </button>
                </div>
            </div>

             <div id="loading" class="hidden flex items-center gap-2 text-gray-600 mt-4">
                <div class="spinner"></div>
                <span>Buscando dados... Isso pode levar um momento.</span>
            </div>

            <div class="mt-6 border-t pt-6">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div>
                        <h3 class="text-lg font-semibold mb-2 flex items-center">
                            <i class="fas fa-history mr-2"></i>Consultar Histórico
                        </h3>
                         <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-4">
                            <select id="history-selector" class="h-10 border rounded-md px-3 py-2 w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="">Nenhum histórico salvo</option>
                            </select>
                            <button id="clear-history-button" class="h-10 bg-red-600 text-white font-bold py-2 px-4 rounded hover:bg-red-700 transition duration-300 flex items-center justify-center gap-2">
                                <i class="fas fa-trash"></i> Limpar Histórico
                            </button>
                         </div>
                    </div>
                    <div class="flex flex-col">
                         <label class="block text-sm font-medium text-gray-700 mb-1">Exportar Dados Filtrados</label>
                         <div class="flex gap-4">
                             <button id="download-csv-button" class="h-10 w-full bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-700 transition duration-300 flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i> CSV
                            </button>
                            <button id="download-json-button" class="h-10 w-full bg-purple-600 text-white font-bold py-2 px-4 rounded hover:bg-purple-700 transition duration-300 flex items-center justify-center gap-2">
                                <i class="fas fa-file-code"></i> JSON
                            </button>
                         </div>
                     </div>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table id="weather-table" class="w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3">Município</th>
                            <th scope="col" class="px-6 py-3">Estado</th>
                            <th scope="col" class="px-6 py-3">Data da Coleta</th>
                            <th scope="col" class="px-6 py-3">Temperatura (°C)</th>
                            <th scope="col" class="px-6 py-3">Umidade (%)</th>
                            <th scope="col" class="px-6 py-3">Vento (km/h)</th>
                            <th scope="col" class="px-6 py-3">Condição</th>
                        </tr>
                    </thead>
                    <tbody id="weather-table-body">
                       <tr>
                           <td colspan="7" class="text-center p-8 text-gray-500">Carregando dados...</td>
                       </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
    
    <footer class="footer py-8 mt-auto" role="contentinfo">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h4 class="text-lg font-semibold mb-4">Portal Meteorológico</h4>
                    <p class="text-gray-300">Fornecendo informações meteorológicas precisas para a região amazônica.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Links Rápidos</h4>
                    <ul class="space-y-2">
                        <li><a href="index.html" class="text-gray-300 hover:text-white transition focus-visible">Dashboard</a></li>
                        <li><a href="Tabela_Todos_Municipios.html" class="text-gray-300 hover:text-white transition focus-visible">Tabela de Municípios</a></li>
                        <li><a href="Contato.html" class="text-gray-300 hover:text-white transition focus-visible">Contato</a></li>
                        <li><a href="Sobre.html" class="text-gray-300 hover:text-white transition focus-visible">Sobre</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold mb-4">Contato</h4>
                    <ul class="space-y-2 text-gray-300">
                        <li class="flex items-center"><i class="fas fa-phone mr-2"></i><span>(69) 99264-6823</span></li>
                        <li class="flex items-center"><i class="fas fa-envelope mr-2"></i><span>contato@Portalmeteorológico</span></li>
                        <li class="flex items-center"><i class="fas fa-map-marker-alt mr-2"></i><span>Antonio Fraga Moreira, 3816</span></li>
                    </ul>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2025 Portal Meteorológico - Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });
        
        const apiKey = '3a8483478c92616b740ea1e354c8a8e9'; 

        const citiesByState = {
            'RO': { 'Alta Floresta D\'Oeste': { lat: -11.9283, lon: -61.9961 }, 'Alto Alegre dos Parecis': { lat: -12.128, lon: -61.821 }, 'Alto Paraíso': { lat: -9.71667, lon: -63.3169 }, 'Alvorada D\'Oeste': { lat: -11.3458, lon: -62.355 }, 'Ariquemes': { lat: -9.9133, lon: -63.0408 }, 'Buritis': { lat: -10.2033, lon: -63.8292 }, 'Cabixi': { lat: -13.4936, lon: -60.5511 }, 'Cacaulândia': { lat: -10.3478, lon: -62.8931 }, 'Cacoal': { lat: -11.4386, lon: -61.4478 }, 'Campo Novo de Rondônia': { lat: -10.5708, lon: -63.6192 }, 'Candeias do Jamari': { lat: -8.79056, lon: -63.7025 }, 'Castanheiras': { lat: -11.4178, lon: -61.9483 }, 'Cerejeiras': { lat: -13.1894, lon: -60.8161 }, 'Chupinguaia': { lat: -12.5492, lon: -60.8994 }, 'Colorado do Oeste': { lat: -13.1331, lon: -60.5503 }, 'Corumbiara': { lat: -12.9864, lon: -60.9419 }, 'Costa Marques': { lat: -12.4419, lon: -64.2294 }, 'Cujubim': { lat: -9.37028, lon: -62.5975 }, 'Espigão D\'Oeste': { lat: -11.525, lon: -61.0208 }, 'Governador Jorge Teixeira': { lat: -10.8631, lon: -62.7761 }, 'Guajará-Mirim': { lat: -10.7828, lon: -65.3361 }, 'Itapuã do Oeste': { lat: -9.28056, lon: -63.155 }, 'Jaru': { lat: -10.4389, lon: -62.4664 }, 'Ji-Paraná': { lat: -10.885, lon: -61.945 }, 'Machadinho D\'Oeste': { lat: -9.43194, lon: -61.98 }, 'Ministro Andreazza': { lat: -11.1969, lon: -61.5161 }, 'Mirante da Serra': { lat: -11.1736, lon: -62.6719 }, 'Monte Negro': { lat: -10.2933, lon: -63.3236 }, 'Nova Brasilândia D\'Oeste': { lat: -11.7108, lon: -62.3397 }, 'Nova Mamoré': { lat: -10.4072, lon: -65.3217 }, 'Nova União': { lat: -11.0503, lon: -62.5694 }, 'Novo Horizonte do Oeste': { lat: -11.7056, lon: -62.0017 }, 'Ouro Preto do Oeste': { lat: -10.7481, lon: -62.2158 }, 'Parecis': { lat: -12.21, lon: -61.5958 }, 'Pimenta Bueno': { lat: -11.6725, lon: -61.1925 }, 'Pimenteiras do Oeste': { lat: -13.4739, lon: -61.0458 }, 'Porto Velho': { lat: -8.7619, lon: -63.9039 }, 'Presidente Médici': { lat: -11.175, lon: -61.9014 }, 'Primavera de Rondônia': { lat: -11.8153, lon: -61.3208 }, 'Rio Crespo': { lat: -9.73333, lon: -62.9094 }, 'Rolim de Moura': { lat: -11.7258, lon: -61.7772 }, 'Santa Luzia D\'Oeste': { lat: -11.9139, lon: -61.7825 }, 'São Felipe D\'Oeste': { lat: -11.9011, lon: -61.4722 }, 'São Francisco do Guaporé': { lat: -12.0622, lon: -63.5756 }, 'São Miguel do Guaporé': { lat: -11.6917, lon: -62.7092 }, 'Seringueiras': { lat: -11.7333, lon: -63.0239 }, 'Teixeirópolis': { lat: -10.9667, lon: -62.2536 }, 'Theobroma': { lat: -10.2333, lon: -62.3417 }, 'Urupá': { lat: -11.135, lon: -62.365 }, 'Vale do Anari': { lat: -9.88333, lon: -62.15 }, 'Vale do Paraíso': { lat: -10.4286, lon: -62.1389 }, 'Vilhena': { lat: -12.7406, lon: -60.1458 } },
            'AC': { 'Acrelândia': { lat: -9.82778, lon: -66.8975 }, 'Assis Brasil': { lat: -10.9411, lon: -69.5703 }, 'Brasiléia': { lat: -11.0119, lon: -68.7481 }, 'Bujari': { lat: -9.83222, lon: -67.9511 }, 'Capixaba': { lat: -10.5739, lon: -67.6833 }, 'Cruzeiro do Sul': { lat: -7.6297, lon: -72.6708 }, 'Epitaciolândia': { lat: -11.0194, lon: -68.7369 }, 'Feijó': { lat: -8.16389, lon: -70.3536 }, 'Jordão': { lat: -9.43278, lon: -71.8883 }, 'Mâncio Lima': { lat: -7.61417, lon: -72.8958 }, 'Manoel Urbano': { lat: -8.83889, lon: -69.2597 }, 'Marechal Thaumaturgo': { lat: -8.93972, lon: -72.7381 }, 'Plácido de Castro': { lat: -10.3344, lon: -67.1856 }, 'Porto Acre': { lat: -9.58722, lon: -67.5333 }, 'Porto Walter': { lat: -8.26861, lon: -72.7439 }, 'Rio Branco': { lat: -9.974, lon: -67.81 }, 'Rodrigues Alves': { lat: -7.74028, lon: -72.6481 }, 'Santa Rosa do Purus': { lat: -9.43833, lon: -70.4939 }, 'Sena Madureira': { lat: -9.0667, lon: -68.6569 }, 'Senador Guiomard': { lat: -10.1503, lon: -67.5367 }, 'Taruacá': { lat: -8.1614, lon: -70.7661 }, 'Xapuri': { lat: -10.6519, lon: -68.5042 } },
            'MT': { 'Acorizal': { lat: -15.1953, lon: -56.3683 }, 'Água Boa': { lat: -14.3475, lon: -52.1558 }, 'Alta Floresta': { lat: -9.87556, lon: -56.0861 }, 'Alto Araguaia': { lat: -17.3147, lon: -53.2153 }, 'Alto Boa Vista': { lat: -11.6742, lon: -51.385 }, 'Alto Garças': { lat: -16.945, lon: -53.6289 }, 'Alto Paraguai': { lat: -14.5153, lon: -56.48 }, 'Alto Taquari': { lat: -17.8258, lon: -53.2825 }, 'Apiacás': { lat: -9.54167, lon: -57.4514 }, 'Araguaiana': { lat: -15.7278, lon: -51.8294 }, 'Araguainha': { lat: -16.855, lon: -53.0319 }, 'Araputanga': { lat: -15.4678, lon: -58.3497 }, 'Arenápolis': { lat: -14.4519, lon: -56.8458 }, 'Aripuanã': { lat: -10.165, lon: -59.4569 }, 'Barão de Melgaço': { lat: -16.195, lon: -55.9675 }, 'Barra do Bugres': { lat: -15.0747, lon: -57.1811 }, 'Barra do Garças': { lat: -15.8903, lon: -52.2567 }, 'Bom Jesus do Araguaia': { lat: -12.1833, lon: -51.35 }, 'Brasnorte': { lat: -12.1539, lon: -57.9786 }, 'Cáceres': { lat: -16.0708, lon: -57.6792 }, 'Campinápolis': { lat: -14.5028, lon: -52.8875 }, 'Campo Novo do Parecis': { lat: -13.6769, lon: -57.8889 }, 'Campo Verde': { lat: -15.545, lon: -55.1683 }, 'Campos de Júlio': { lat: -13.5244, lon: -59.0883 }, 'Canabrava do Norte': { lat: -11.0181, lon: -51.8317 }, 'Canarana': { lat: -13.5539, lon: -52.2706 }, 'Carlinda': { lat: -9.95, lon: -55.85 }, 'Castanheira': { lat: -11.1072, lon: -58.6017 }, 'Chapada dos Guimarães': { lat: -15.4606, lon: -55.7497 }, 'Cláudia': { lat: -11.5167, lon: -55.2 }, 'Cocalinho': { lat: -14.3853, lon: -51.0114 }, 'Colíder': { lat: -10.8189, lon: -55.4561 }, 'Colniza': { lat: -9.48889, lon: -59.215 }, 'Comodoro': { lat: -13.6639, lon: -59.785 }, 'Confresa': { lat: -10.6433, lon: -51.5694 }, 'Conquista D\'Oeste': { lat: -14.5511, lon: -59.5786 }, 'Cotriguaçu': { lat: -9.84917, lon: -58.2439 }, 'Cuiabá': { lat: -15.5989, lon: -56.0949 }, 'Curvelândia': { lat: -15.6186, lon: -57.9422 }, 'Denise': { lat: -14.7381, lon: -57.0531 }, 'Diamantino': { lat: -14.4086, lon: -56.4458 }, 'Dom Aquino': { lat: -15.8075, lon: -54.9189 }, 'Feliz Natal': { lat: -12.3917, lon: -54.9192 }, 'Figueirópolis D\'Oeste': { lat: -15.4419, lon: -58.7306 }, 'Gaúcha do Norte': { lat: -13.2425, lon: -53.0789 }, 'General Carneiro': { lat: -15.7083, lon: -52.7567 }, 'Glória D\'Oeste': { lat: -15.7558, lon: -58.3061 }, 'Guarantã do Norte': { lat: -9.78694, lon: -54.8889 }, 'Guiratinga': { lat: -16.3439, lon: -53.7581 }, 'Indiavaí': { lat: -15.4919, lon: -58.5789 }, 'Ipiranga do Norte': { lat: -12.2403, lon: -56.1533 }, 'Itanhangá': { lat: -12.2258, lon: -56.6461 }, 'Itaúba': { lat: -11.0617, lon: -55.2764 }, 'Itiquira': { lat: -17.2139, lon: -54.1422 }, 'Jaciara': { lat: -15.9658, lon: -54.9683 }, 'Jangada': { lat: -15.235, lon: -56.4917 }, 'Jauru': { lat: -15.3386, lon: -58.8728 }, 'Juara': { lat: -11.2639, lon: -57.5242 }, 'Juína': { lat: -11.3786, lon: -58.7481 }, 'Juruena': { lat: -10.3169, lon: -58.3594 }, 'Juscimeira': { lat: -16.0519, lon: -54.8828 }, 'Lambari D\'Oeste': { lat: -15.3189, lon: -58.0047 }, 'Lucas do Rio Verde': { lat: -13.0628, lon: -55.9172 }, 'Luciara': { lat: -11.2219, lon: -50.6675 }, 'Marcelândia': { lat: -11.1267, lon: -54.4378 }, 'Matupá': { lat: -10.0519, lon: -54.9317 }, 'Mirassol d\'Oeste': { lat: -15.6758, lon: -58.095 }, 'Nobres': { lat: -14.7192, lon: -56.3275 }, 'Nortelândia': { lat: -14.4539, lon: -56.8028 }, 'Nossa Senhora do Livramento': { lat: -15.7758, lon: -56.3433 }, 'Nova Bandeirantes': { lat: -9.84806, lon: -57.8139 }, 'Nova Brasilândia': { lat: -14.9611, lon: -54.9689 }, 'Nova Canaã do Norte': { lat: -10.5578, lon: -55.9536 }, 'Nova Guarita': { lat: -10.3069, lon: -55.4061 }, 'Nova Lacerda': { lat: -14.4758, lon: -59.5786 }, 'Nova Marilândia': { lat: -14.3628, lon: -56.9694 }, 'Nova Maringá': { lat: -13.0136, lon: -57.0908 }, 'Nova Monte Verde': { lat: -9.98, lon: -57.4761 }, 'Nova Mutum': { lat: -13.8233, lon: -56.0831 }, 'Nova Nazaré': { lat: -13.9886, lon: -51.7994 }, 'Nova Olímpia': { lat: -14.7886, lon: -57.2886 }, 'Nova Santa Helena': { lat: -10.865, lon: -55.1872 }, 'Nova Ubiratã': { lat: -12.9989, lon: -55.2553 }, 'Nova Xavantina': { lat: -14.6767, lon: -52.3539 }, 'Novo Horizonte do Norte': { lat: -11.4089, lon: -57.3489 }, 'Novo Mundo': { lat: -9.95611, lon: -55.1886 }, 'Novo Santo Antônio': { lat: -12.2883, lon: -50.9678 }, 'Novo São Joaquim': { lat: -14.9053, lon: -53.0192 }, 'Paranaíta': { lat: -9.66528, lon: -56.4789 }, 'Paranatinga': { lat: -14.4267, lon: -54.0528 }, 'Pedra Preta': { lat: -16.6222, lon: -54.4722 }, 'Peixoto de Azevedo': { lat: -10.2458, lon: -54.9906 }, 'Planalto da Serra': { lat: -14.665, lon: -54.7733 }, 'Poconé': { lat: -16.2561, lon: -56.6228 }, 'Pontal do Araguaia': { lat: -15.8369, lon: -52.7767 }, 'Ponte Branca': { lat: -16.7583, lon: -52.8369 }, 'Pontes e Lacerda': { lat: -15.2258, lon: -59.3433 }, 'Porto Alegre do Norte': { lat: -10.8769, lon: -51.6358 }, 'Porto dos Gaúchos': { lat: -11.5231, lon: -57.4139 }, 'Porto Esperidião': { lat: -15.8572, lon: -58.4619 }, 'Porto Estrela': { lat: -15.3236, lon: -57.2206 }, 'Poxoréu': { lat: -15.8372, lon: -54.3892 }, 'Primavera do Leste': { lat: -15.5239, lon: -54.3439 }, 'Querência': { lat: -12.6092, lon: -52.1822 }, 'Reserva do Cabaçal': { lat: -15.1228, lon: -58.3831 }, 'Ribeirão Cascalheira': { lat: -12.9369, lon: -51.8244 }, 'Ribeirãozinho': { lat: -16.4853, lon: -52.6925 }, 'Rio Branco': { lat: -15.2483, lon: -58.1258 }, 'Rondolândia': { lat: -10.8375, lon: -61.4694 }, 'Rondonópolis': { lat: -16.4708, lon: -54.6358 }, 'Rosário Oeste': { lat: -14.8358, lon: -56.4275 }, 'Salto do Céu': { lat: -15.1303, lon: -58.1317 }, 'Santa Carmem': { lat: -11.9125, lon: -55.2264 }, 'Santa Cruz do Xingu': { lat: -10.1531, lon: -52.3953 }, 'Santa Rita do Trivelato': { lat: -13.8106, lon: -55.2706 }, 'Santa Terezinha': { lat: -10.4703, lon: -50.5142 }, 'Santo Afonso': { lat: -14.4942, lon: -57.0056 }, 'Santo Antônio do Leste': { lat: -14.805, lon: -53.6078 }, 'Santo Antônio do Leverger': { lat: -15.8658, lon: -56.0769 }, 'São Félix do Araguaia': { lat: -11.615, lon: -50.6686 }, 'São José do Povo': { lat: -16.4658, lon: -54.2553 }, 'São José do Rio Claro': { lat: -13.4419, lon: -56.7217 }, 'São José do Xingu': { lat: -10.7972, lon: -52.7386 }, 'São José dos Quatro Marcos': { lat: -15.6275, lon: -58.1772 }, 'São Pedro da Cipa': { lat: -16.0008, lon: -54.9206 }, 'Sapezal': { lat: -13.545, lon: -58.8158 }, 'Serra Nova Dourada': { lat: -12.0894, lon: -51.4036 }, 'Sinop': { lat: -11.8639, lon: -55.5039 }, 'Sorriso': { lat: -12.5425, lon: -55.7211 }, 'Tabaporã': { lat: -11.3008, lon: -56.8311 }, 'Tangará da Serra': { lat: -14.6228, lon: -57.4933 }, 'Tapurah': { lat: -12.5328, lon: -56.5033 }, 'Terra Nova do Norte': { lat: -10.5172, lon: -55.2311 }, 'Tesouro': { lat: -16.0808, lon: -53.5539 }, 'Torixoréu': { lat: -16.1967, lon: -52.5569 }, 'União do Sul': { lat: -11.5308, lon: -54.1158 }, 'Vale de São Domingos': { lat: -15.2939, lon: -59.0667 }, 'Várzea Grande': { lat: -15.6469, lon: -56.1325 }, 'Vera': { lat: -12.3017, lon: -55.3044 }, 'Vila Bela da Santíssima Trindade': { lat: -15.0089, lon: -59.9503 }, 'Vila Rica': { lat: -10.0139, lon: -51.1186 } }
        };

        const fetchButton = document.getElementById('fetch-button');
        const tableBody = document.getElementById('weather-table-body');
        const loadingIndicator = document.getElementById('loading');
        const historySelector = document.getElementById('history-selector');
        const clearHistoryButton = document.getElementById('clear-history-button');
        const downloadCsvButton = document.getElementById('download-csv-button');
        const downloadJsonButton = document.getElementById('download-json-button');
        const stateFilter = document.getElementById('state-filter');
        const clearFiltersButton = document.getElementById('clear-filters-button');

        const cityFilterContainer = document.getElementById('city-filter-container');
        const cityFilterButton = document.getElementById('city-filter-button');
        const cityFilterText = document.getElementById('city-filter-text');
        const cityFilterOptions = document.getElementById('city-filter-options');

        function populateTable(dataArray) {
            const rowsHtml = dataArray.map(data => {
                const date = new Date(data.timestamp);
                const formattedDate = date.toLocaleString('pt-BR');
                return `
                    <tr class="bg-white border-b hover:bg-gray-50">
                        <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${data.city}</td>
                        <td class="px-6 py-4">${data.state}</td>
                        <td class="px-6 py-4">${formattedDate}</td>
                        <td class="px-6 py-4">${data.temp}°C</td>
                        <td class="px-6 py-4">${data.humidity}%</td>
                        <td class="px-6 py-4">${data.wind} km/h</td>
                        <td class="px-6 py-4 capitalize">${data.condition}</td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = rowsHtml || '<tr><td colspan="7" class="text-center p-8">Nenhum dado encontrado.</td></tr>';
        }

        async function fetchAllWeatherData() {
            loadingIndicator.classList.remove('hidden');
            fetchButton.disabled = true;
            
            const timestamp = new Date().toISOString();
            const citiesToFetch = [];

            for (const state in citiesByState) {
                for (const city in citiesByState[state]) {
                    citiesToFetch.push({ state, city, ...citiesByState[state][city] });
                }
            }
            
            const promises = citiesToFetch.map(cityInfo => 
                fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${cityInfo.lat}&lon=${cityInfo.lon}&appid=${apiKey}&units=metric&lang=pt_br`)
                    .then(res => res.ok ? res.json() : Promise.reject(`Erro em ${cityInfo.city}`))
                    .then(data => ({
                        city: cityInfo.city,
                        state: cityInfo.state,
                        timestamp,
                        temp: Math.round(data.main.temp),
                        humidity: data.main.humidity,
                        wind: Math.round(data.wind.speed * 3.6),
                        condition: data.weather[0].description
                    }))
                    .catch(error => {
                        console.error(error);
                        return null;
                    })
            );

            const results = await Promise.all(promises);
            const successfulResults = results.filter(r => r !== null);

            populateTable(successfulResults);
            saveHistory(timestamp, successfulResults);
            loadHistoryOptions();
            applyFilters();
            
            loadingIndicator.classList.add('hidden');
            fetchButton.disabled = false;
        }
        
        function updateCityFilterText() {
            const checked = cityFilterOptions.querySelectorAll('input[type="checkbox"]:checked');
            const selectAllChecked = cityFilterOptions.querySelector('input[value="todos"]:checked');
            
            if (checked.length === 0 || selectAllChecked) {
                 cityFilterText.textContent = 'Todos os Municípios';
            } else if (checked.length === 1) {
                cityFilterText.textContent = checked[0].name;
            } else {
                cityFilterText.textContent = `${checked.length} municípios selecionados`;
            }
        }
        
        function populateCityFilter(state) {
            cityFilterOptions.innerHTML = '';
            if (state === 'todos') {
                cityFilterButton.disabled = true;
                cityFilterText.textContent = 'Selecione um estado';
                cityFilterText.classList.add('text-gray-500');
                return;
            }
            
            cityFilterButton.disabled = false;
            cityFilterText.textContent = 'Todos os Municípios';
            cityFilterText.classList.remove('text-gray-500');

            const cities = Object.keys(citiesByState[state]).sort((a, b) => a.localeCompare(b));
            
            const allOptionItem = document.createElement('div');
            allOptionItem.className = 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-gray-100';
            allOptionItem.innerHTML = `
                <label class="flex items-center space-x-3">
                    <input type="checkbox" name="todos" value="todos" class="h-4 w-4 border-gray-300 rounded text-green-600 focus:ring-green-500">
                    <span class="font-semibold block truncate">Todos os Municípios</span>
                </label>
            `;
            cityFilterOptions.appendChild(allOptionItem);
            
            cities.forEach(city => {
                const optionItem = document.createElement('div');
                optionItem.className = 'cursor-pointer select-none relative py-2 pl-3 pr-9 text-gray-900 hover:bg-gray-100';
                optionItem.innerHTML = `
                    <label class="flex items-center space-x-3">
                         <input type="checkbox" name="${city}" value="${city}" class="h-4 w-4 border-gray-300 rounded text-green-600 focus:ring-green-500">
                        <span class="font-normal block truncate">${city}</span>
                    </label>
                `;
                cityFilterOptions.appendChild(optionItem);
            });
            
            const allCheckbox = cityFilterOptions.querySelector('input[value="todos"]');
            const cityCheckboxes = cityFilterOptions.querySelectorAll('input[type="checkbox"]:not([value="todos"])');

            allCheckbox.addEventListener('change', () => {
                cityCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
                updateCityFilterText();
                applyFilters();
            });

            cityCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (!cb.checked) {
                        allCheckbox.checked = false;
                    } else if ([...cityCheckboxes].every(c => c.checked)) {
                        allCheckbox.checked = true;
                    }
                    updateCityFilterText();
                    applyFilters();
                });
            });
        }

        function applyFilters() {
            const selectedState = stateFilter.value;
            const checkedCheckboxes = cityFilterOptions.querySelectorAll('input:checked');
            const selectedCities = Array.from(checkedCheckboxes).map(cb => cb.value);

            const rows = tableBody.getElementsByTagName('tr');

            for (const row of rows) {
                if (row.cells.length < 7) continue;

                const rowState = row.cells[1].textContent;
                const rowCity = row.cells[0].textContent;
                
                const stateMatch = selectedState === 'todos' || rowState === selectedState;
                const cityMatch = selectedCities.length === 0 || selectedCities.includes('todos') || selectedCities.includes(rowCity);

                if (stateMatch && cityMatch) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }
        
        function clearFilters() {
            stateFilter.value = 'todos';
            populateCityFilter('todos');
            applyFilters();
        }

        cityFilterButton.addEventListener('click', () => {
            cityFilterOptions.classList.toggle('hidden');
        });

        window.addEventListener('click', (e) => {
            if (!cityFilterContainer.contains(e.target)) {
                cityFilterOptions.classList.add('hidden');
            }
        });
        
        function downloadCSV() {
            const table = document.getElementById('weather-table');
            let csv = [];
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            csv.push(headers.join(','));
            table.querySelectorAll('tbody tr').forEach(row => {
                if (row.style.display !== 'none' && row.cells.length > 1) {
                    const rowData = Array.from(row.querySelectorAll('td')).map(td => `"${td.textContent.replace(/"/g, '""')}"`);
                    csv.push(rowData.join(','));
                }
            });
            if (csv.length <= 1) {
                alert("Nenhum dado para baixar. Tente limpar os filtros ou carregar dados primeiro.");
                return;
            }
            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'dados_meteorologicos.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function downloadJSON() {
            const table = document.getElementById('weather-table');
            const data = [];
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
            table.querySelectorAll('tbody tr').forEach(row => {
                if (row.style.display !== 'none' && row.cells.length > 1) {
                    const rowData = {};
                    Array.from(row.querySelectorAll('td')).forEach((td, index) => {
                        rowData[headers[index]] = td.textContent;
                    });
                    data.push(rowData);
                }
            });
            if (data.length === 0) {
                alert("Nenhum dado para baixar. Tente limpar os filtros ou carregar dados primeiro.");
                return;
            }
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'dados_meteorologicos.json');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function getHistory() {
            return JSON.parse(localStorage.getItem('weatherHistory')) || [];
        }

        function saveHistory(timestamp, data) {
            if (!data || data.length === 0) return;
            const history = getHistory();
            history.unshift({ timestamp, data });
            if (history.length > 20) {
                history.pop();
            }
            localStorage.setItem('weatherHistory', JSON.stringify(history));
        }

        function loadHistoryOptions() {
            const history = getHistory();
            historySelector.innerHTML = '<option value="">Selecione um registro do histórico</option>';
            if (history.length === 0) {
                historySelector.firstElementChild.textContent = 'Nenhum histórico salvo';
                return;
            }
            history.forEach((record, index) => {
                const date = new Date(record.timestamp);
                const formattedDate = date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `Registro de: ${formattedDate}`;
                historySelector.appendChild(option);
            });
        }
        
        function loadDataFromHistory(index) {
            if (index === "") {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8">Selecione um registro do histórico para exibir.</td></tr>';
                return;
            };
            const history = getHistory();
            const record = history[index];
            if (!record) return;
            
            populateTable(record.data);
            applyFilters();
        }
        
        function clearHistory() {
            if (confirm('Tem certeza que deseja apagar todo o histórico?')) {
                localStorage.removeItem('weatherHistory');
                loadHistoryOptions();
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center p-8">Histórico limpo.</td></tr>';
            }
        }
        
        fetchButton.addEventListener('click', fetchAllWeatherData);
        clearHistoryButton.addEventListener('click', clearHistory);
        downloadCsvButton.addEventListener('click', downloadCSV);
        downloadJsonButton.addEventListener('click', downloadJSON);
        historySelector.addEventListener('change', (e) => loadDataFromHistory(e.target.value));
        stateFilter.addEventListener('change', () => {
            populateCityFilter(stateFilter.value);
            applyFilters();
        });
        clearFiltersButton.addEventListener('click', clearFilters);

        window.addEventListener('load', () => {
            loadHistoryOptions();
            populateCityFilter('todos');
            fetchAllWeatherData();
        });
    </script>
</body>
</html>